{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Kubernetes on EC2",
    "Resources": {
        "Machine1": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "ami-e18dc5d1",
                "InstanceType": "m3.large",
                "KeyName": "test",
                "UserData": { "Fn::Base64": {"Fn::Join" : ["", [
                    "#cloud-config\n\n",
                    "hostname: master-coreos\n",
                    "coreos:\n",
                    "  fleet:\n",
                    "    etcd_servers: http://127.0.0.1:4001\n",
                    "    metadata: role=master\n",
                    "  etcd:\n",
                    "    name: etcd\n",
                    "    addr: $private_ipv4:4001\n",
                    "    bind-addr: 0.0.0.0\n",
                    "    peer-addr: $private_ipv4:7001\n",
                    "    cluster-active-size: 1\n",
                    "    etcd-http-read-timeout: 86400\n",
                    "    snapshot: true\n",
                    "  update:\n",
                    "    group: alpha\n",
                    "    reboot-strategy: off\n"
                ]]}
                            }
            }
        },
        "Machine2": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": "ami-e18dc5d1",
                "InstanceType": "m3.large",
                "KeyName": "test",
                "UserData": { "Fn::Base64": {"Fn::Join" : ["", [
                    "#cloud-config\n\n",
                    "coreos:\n",
                    "  fleet:\n",
                    "    etcd_servers: http://", {"Fn::GetAtt":["KubernetesMasterInstance" , "PrivateIp"]}, ":4001\n",
                    "    metadata: role=knode\n",
                    "  units:\n",
                    "    - name: format-ephemeral.service\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        Description=Formats the ephemeral drive\n",
                    "        [Service]\n",
                    "        Type=oneshot\n",
                    "        RemainAfterExit=yes\n",
                    "        ExecStart=/usr/sbin/wipefs -f /dev/xvdb\n",
                    "        ExecStart=/usr/sbin/mkfs.btrfs -f /dev/xvdb\n",
                    "    - name: data-create.service\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        Description=Created the /data directory\n",
                    "        [Service]\n",
                    "        Type=oneshot\n",
                    "        RemainAfterExit=yes\n",
                    "        ExecStart=-/usr/bin/mkdir -p /data\n",
                    "    - name: data.mount\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        Description=Mount ephemeral to /data\n",
                    "        After=data-create.service format-ephemeral.service\n",
                    "        [Mount]\n",
                    "        What=/dev/xvdb\n",
                    "        Where=/data\n",
                    "        Type=btrfs\n",
                    "    - name: etcd.service\n",
                    "      mask: true\n",
                    "    - name: fleet.service\n",
                    "      command: start\n",
                    "    - name: flannel.service\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        After=network-online.target\n",
                    "        Wants=network-online.target\n",
                    "        Description=flannel is an etcd backed overlay network for containers\n\n",
                    "        [Service]\n",
                    "        Type=notify\n",
                    "        ExecStartPre=-/usr/bin/mkdir -p /opt/bin\n",
                    "        ExecStartPre=/usr/bin/wget -N -P /opt/bin https://storage.googleapis.com/k8s/flanneld\n",
                    "        ExecStartPre=/usr/bin/chmod +x /opt/bin/flanneld\n",
                    "        ExecStart=/opt/bin/flanneld -etcd-endpoints http://", {"Fn::GetAtt" :["KubernetesMasterInstance" , "PrivateIp"]}, ":4001\n",
                    "    - name: kube-kubelet.service\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        Description=Kubernetes Kubelet\n",
                    "        Documentation=https://github.com/GoogleCloudPlatform/kubernetes\n",
                    "        Requires=setup-network-environment.service\n",
                    "        After=setup-network-environment.service\n\n",
                    "        [Service]\n",
                    "        EnvironmentFile=/etc/network-environment\n",
                    "        ExecStartPre=/usr/bin/wget -N -P /opt/bin https://storage.googleapis.com/kubernetes-release/release/v0.5.4/bin/linux/amd64/kubelet\n",
                    "        ExecStartPre=/usr/bin/chmod +x /opt/bin/kubelet\n",
                    "        ExecStart=/opt/bin/kubelet \\\n",
                    "        --address=0.0.0.0 \\\n",
                    "        --port=10250 \\\n",
                    "        --hostname_override=${DEFAULT_IPV4} \\\n",
                    "        --etcd_servers=http://", {"Fn::GetAtt" :["KubernetesMasterInstance" , "PrivateIp"]}, ":4001\\\n",
                    "        --logtostderr=true\n",
                    "        Restart=always\n",
                    "        RestartSec=10\n",
                    "    - name: kube-proxy.service\n",
                    "      command: start\n",
                    "      content: |\n",
                    "        [Unit]\n",
                    "        Description=Kubernetes Proxy\n",
                    "        Documentation=https://github.com/GoogleCloudPlatform/kubernetes\n",
                    "        Requires=setup-network-environment.service\n",
                    "        After=setup-network-environment.service\n\n",
                    "        [Service]\n",
                    "        ExecStartPre=/usr/bin/wget -N -P /opt/bin https://storage.googleapis.com/kubernetes-release/release/v0.5.4/bin/linux/amd64/kube-proxy\n",
                    "        ExecStartPre=/usr/bin/chmod +x /opt/bin/kube-proxy\n",
                    "        ExecStart=/opt/bin/kube-proxy \\\n",
                    "        --etcd_servers=http://", {"Fn::GetAtt" :["KubernetesMasterInstance" , "PrivateIp"]}, ":4001\\\n",
                    "        --logtostderr=true\n",
                    "        Restart=always\n",
                    "        RestartSec=10\n",
                    "  update:\n",
                    "    group: alpha\n",
                    "    reboot-strategy: off\n"
                ]]}
                            }
            }
        },
        "KubernetesAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AvailabilityZones": {"Fn::GetAZs": ""},
                "LaunchConfigurationName": {"Ref": "KubernetesNodeLaunchConfig"},
                "MinSize": "3",
                "MaxSize": "12",
                "DesiredCapacity": {"Ref": "ClusterSize"}
            }
        }
    },
    "Outputs": {
        "KubernetesMasterPublicIp": {
            "Description": "Public Ip of the newly created Kubernetes Master instance",
            "Value": {"Fn::GetAtt": ["KubernetesMasterInstance" , "PublicIp"]}
        }
    }
}
